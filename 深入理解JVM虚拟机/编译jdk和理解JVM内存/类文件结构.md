## 类文件结构

```java
public class TestClass {
	private int m;
	public int inc() {
	return m + 1;}
}
```

#### 1.魔数

​	每个Class文件的头四个字节被称为Magic Number，用来判断一个文件是否是能被虚拟机接收的Class文件，下图是使用ImHex观察到的，后面也都是如此。

![image-20240905213531509](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905213531509.png)

#### 2.版本号

​	紧接着后四位是Class文件的版本号，第五和第六表示次版本号MinorVersion，第七和第八表示主版本号Major Version。高版本JDK可以向下兼容以前版本的Class文件，但不能运行之后的版本，所以虚拟机拒绝执行超过其版本号的Class文件。

![image-20240905213859730](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905213859730.png)

![image-20240905213922540](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905213922540.png)

​	可以看到笔者使用的是jdk17进行的编译

#### 3.常量池

​	接着后四位表示常量池中容量计数器，要注意的是它是从一开始计数

![image-20240905214657824](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905214657824.png)

​	这里的偏移量是转为十进制后是19，代表常量池中有19个常量。其中主要存放两大类常量：字面量(Literal)和符号引用(Symbolic Reference)。字面量像是文本字符串，被声明有final的常量值。而符号引用就有很多了。Package包名，Full Qualified Name类和接口的全限定名，Descriptor字段，方法名称和描述符。Method Handle，Method Type，Invoke Dynamic方法句柄和类型。Dynamically-Computed Call Site，Dynamically-Computed Constant动态调用点和动态常量。

​	下图是常量池标志对应表，可以看到总共有17中常量类型。

![image-20240905220531983](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905220531983.png)

​	下面是使用javap名称输出常量表

![image-20240905221119372](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905221119372.png)

![image-20240905221642311](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905221642311.png)	

​	这里分析一下它的开始和结尾

```yaml
Methodrdf  <—— :tag 10	表示方法引用
	:class_index 2 指向常量池中的第 2 项。这个索引指向了一个 Class 常量表项，它标识了这个方法所属的类或接口
	:name_and_type_index 3  指向常量池中的某个 NameAndType 项。这个索引标识了该方法的名称和签名（即方法参数和返回值的类型）
```

![](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905223525931.png)

​	CONSTANT_Utf8_info型常量的结构  

![image-20240905223340953](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905223340953.png)

```
Utf-8 <—— :tag 1  表明它是一个字符串
	：length 14 
	:bytes "TestClass.java"
```

#### 4.访问标志

![image-20240905225428573](C:\Users\lord2\AppData\Roaming\Typora\typora-user-images\image-20240905225428573.png)

​	在常量池之后就是2个字节代表访问标志 access_flags。例C拉萨市是类还是接口；是否为public，abstract；如果是类是否被声明为final....

```
ACC_PUBLIC,ACC_FINAL,ACC_SUPER,ACC_INTERFACE,ACC_ASBTRACT,ACC_SYNTHETIC,ACC_ANNOTATION,ACC_ENUM,ACC_MODULE
```

​	0x0021其中2表示ACC_SUPER，1表示ACC_PUBLIC

#### 5.类索引，父类索引，接口索引集合